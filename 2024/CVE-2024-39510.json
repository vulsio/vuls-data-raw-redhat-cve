{
	"name": "CVE-2024-39510",
	"threat_severity": "Moderate",
	"public_date": "2024-07-12T00:00:00Z",
	"bugzilla": {
		"description": "kernel: cachefiles: fix slab-use-after-free in cachefiles_ondemand_daemon_read()",
		"id": "2297482",
		"url": "https://bugzilla.redhat.com/show_bug.cgi?id=2297482"
	},
	"cvss3": {
		"cvss3_base_score": "6.1",
		"cvss3_scoring_vector": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:H",
		"status": "draft"
	},
	"cwe": "CWE-416",
	"details": [
		"In the Linux kernel, the following vulnerability has been resolved:\ncachefiles: fix slab-use-after-free in cachefiles_ondemand_daemon_read()\nWe got the following issue in a fuzz test of randomly issuing the restore\ncommand:\n==================================================================\nBUG: KASAN: slab-use-after-free in cachefiles_ondemand_daemon_read+0xb41/0xb60\nRead of size 8 at addr ffff888122e84088 by task ondemand-04-dae/963\nCPU: 13 PID: 963 Comm: ondemand-04-dae Not tainted 6.8.0-dirty #564\nCall Trace:\nkasan_report+0x93/0xc0\ncachefiles_ondemand_daemon_read+0xb41/0xb60\nvfs_read+0x169/0xb50\nksys_read+0xf5/0x1e0\nAllocated by task 116:\nkmem_cache_alloc+0x140/0x3a0\ncachefiles_lookup_cookie+0x140/0xcd0\nfscache_cookie_state_machine+0x43c/0x1230\n[...]\nFreed by task 792:\nkmem_cache_free+0xfe/0x390\ncachefiles_put_object+0x241/0x480\nfscache_cookie_state_machine+0x5c8/0x1230\n[...]\n==================================================================\nFollowing is the process that triggers the issue:\nmount  |   daemon_thread1    |    daemon_thread2\n------------------------------------------------------------\ncachefiles_withdraw_cookie\ncachefiles_ondemand_clean_object(object)\ncachefiles_ondemand_send_req\nREQ_A = kzalloc(sizeof(*req) + data_len)\nwait_for_completion(&REQ_A->done)\ncachefiles_daemon_read\ncachefiles_ondemand_daemon_read\nREQ_A = cachefiles_ondemand_select_req\nmsg->object_id = req->object->ondemand->ondemand_id\n------ restore ------\ncachefiles_ondemand_restore\nxas_for_each(&xas, req, ULONG_MAX)\nxas_set_mark(&xas, CACHEFILES_REQ_NEW)\ncachefiles_daemon_read\ncachefiles_ondemand_daemon_read\nREQ_A = cachefiles_ondemand_select_req\ncopy_to_user(_buffer, msg, n)\nxa_erase(&cache->reqs, id)\ncomplete(&REQ_A->done)\n------ close(fd) ------\ncachefiles_ondemand_fd_release\ncachefiles_put_object\ncachefiles_put_object\nkmem_cache_free(cachefiles_object_jar, object)\nREQ_A->object->ondemand->ondemand_id\n// object UAF !!!\nWhen we see the request within xa_lock, req->object must not have been\nfreed yet, so grab the reference count of object before xa_unlock to\navoid the above issue."
	],
	"references": [
		"https://www.cve.org/CVERecord?id=CVE-2024-39510\nhttps://nvd.nist.gov/vuln/detail/CVE-2024-39510\nhttps://lore.kernel.org/linux-cve-announce/2024071206-CVE-2024-39510-9f8c@gregkh/T"
	],
	"package_state": [
		{
			"cpe": "cpe:/o:redhat:enterprise_linux:6",
			"fix_state": "Not affected",
			"package_name": "kernel",
			"product_name": "Red Hat Enterprise Linux 6"
		},
		{
			"cpe": "cpe:/o:redhat:enterprise_linux:7",
			"fix_state": "Not affected",
			"package_name": "kernel",
			"product_name": "Red Hat Enterprise Linux 7"
		},
		{
			"cpe": "cpe:/o:redhat:enterprise_linux:7",
			"fix_state": "Not affected",
			"package_name": "kernel-rt",
			"product_name": "Red Hat Enterprise Linux 7"
		},
		{
			"cpe": "cpe:/o:redhat:enterprise_linux:8",
			"fix_state": "Not affected",
			"package_name": "kernel",
			"product_name": "Red Hat Enterprise Linux 8"
		},
		{
			"cpe": "cpe:/o:redhat:enterprise_linux:8",
			"fix_state": "Not affected",
			"package_name": "kernel-rt",
			"product_name": "Red Hat Enterprise Linux 8"
		},
		{
			"cpe": "cpe:/o:redhat:enterprise_linux:9",
			"fix_state": "Not affected",
			"package_name": "kernel",
			"product_name": "Red Hat Enterprise Linux 9"
		},
		{
			"cpe": "cpe:/o:redhat:enterprise_linux:9",
			"fix_state": "Not affected",
			"package_name": "kernel-rt",
			"product_name": "Red Hat Enterprise Linux 9"
		}
	],
	"upstream_fix": "kernel 6.9.6, kernel 6.10-rc4",
	"csaw": false
}
